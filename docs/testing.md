# テスト設計書

## 目次

1. [概要](#1-概要)
2. [テスト方針](#2-テスト方針)
    - [2.1 テストピラミッドと優先度](#21-テストピラミッドと優先度)
    - [2.2 実行タイミング（PR / リリース前）](#22-実行タイミングpr--リリース前)
    - [2.3 テストデータ方針](#23-テストデータ方針)
    - [2.4 可観測性](#24-可観測性)
3. [テスト対象と観点](#3-テスト対象と観点)
    - [3.1 サービス層ユニットテスト（未実装）](#31-サービス層ユニットテスト未実装)
    - [3.2 セキュリティテスト（未実装）](#32-セキュリティテスト未実装)
    - [3.3 型安全性テスト](#33-型安全性テスト)
    - [3.4 ビルドテスト](#34-ビルドテスト)
    - [3.5 コード品質テスト](#35-コード品質テスト)
    - [3.6 E2Eテスト（未実装・リリース前のみ）](#36-e2eテスト未実装リリース前のみ)
4. [CI / ツール構成](#4-ci--ツール構成)
    - [4.1 GitHub Actions ワークフロー](#41-github-actions-ワークフロー)
    - [4.2 導入済みツール](#42-導入済みツール)
    - [4.3 実行環境](#43-実行環境)

## 1. 概要

本ドキュメントは Singularity Lab Portal アプリケーションのテスト方針、テスト対象と観点、CI/ツール構成を整理する。

## 2. テスト方針

### 2.1 テストピラミッドと優先度

```text
    E2E Tests (少数)
  Integration Tests (中程度)
Unit Tests (多数)
```

- **狙い**: 変更頻度が高く壊れやすい領域は Unit/静的検査で早期に検知し、統合・E2E は本数を絞って「破綻していないこと」を確認する。
- **優先度の決め方**: 変更頻度・影響範囲・障害時コストの観点で、認証/認可、データ整合性、ビルド成立性を優先する。

### 2.2 実行タイミング（PR / リリース前）

PR では短時間で完了するチェックを必須とし、リリース前は範囲を絞った確認を追加する。

- **PRで必須**: `npm run lint` / `npx tsc --noEmit` / `npm run build` / `npm test`（変更箇所に関係する範囲）
- **リリース前**: 影響範囲が広い変更に対して、主要フローの手動確認（または最小限のE2E）を追加
- **セキュリティ関連**: 認証/認可/承認の変更がある場合のみ、ユニットはPRで実行し、統合/E2Eはリリース前か ワークフロー手動実行 で実行する

CI のワークフロー一覧は [4.1 GitHub Actions ワークフロー](#41-github-actions-ワークフロー) に記載する。

### 2.3 テストデータ方針

- **原則**: Unit テストはモック/スタブで独立性を確保し、外部依存は直接叩かない。
- **統合確認が必要な場合**: 専用環境とシードデータを前提に、対象を最小限に絞って再現性を担保する。

### 2.4 可観測性

- **失敗時の調査容易性**: どの観点が落ちたかがわかる粒度でチェックを分け、名前で意図がわかるようにする。
- **ログの扱い**: デバッグ出力の混入は検知して失敗させ、原因特定に必要なログだけを残す。

## 3. テスト対象と観点

### 3.1 サービス層ユニットテスト（未実装）

サービス層（ビジネスロジック）の正しさを、外部I/Oから切り離して確認する。

- **観点**
  - 代表的な正常系（CRUDの代表ケース）
  - 入力のバリデーション（代表ケース）
  - 戻り値の型・構造が想定どおりであること（代表レスポンス）
  - 代表的な失敗（例: ネットワーク失敗、制約違反）時の扱い
- **対象領域（最小範囲の例）**
  - コンテンツ取得（一覧・詳細）
  - コンテンツ管理（登録・更新・削除）
  - ユーザー管理（登録・承認）
  - 参照系マスタ（カテゴリ等）
- **実行タイミング**: [2.2 実行タイミング](#22-実行タイミングpr--リリース前) に従い、PRでは変更箇所に限定して追加する。

### 3.2 セキュリティテスト（未実装）

認証・認可・承認ステータスの制御が、意図した振る舞いを満たすことを確認する。

本プロジェクトのセキュリティテストは、**単体で確認できる部分はユニット**、**実際の認証フローに関わる部分は統合/ E2E**に分類する。

- **観点と実行タイミング**
  - **認証制御**: 未認証ユーザーのリダイレクト/ガード。ユニットでヘルパー検証が可能な場合は **毎PR**、統合/ E2E は **リリース前 or ワークフロー手動実行**。
  - **認可制御**: ロール（admin / maintainer / member）に応じた許可/拒否。ユニットで権限判定関数を検証できる場合は **毎PR**、UI/ミドルウェアは **リリース前 or ワークフロー手動実行**。
  - **承認ステータス制御**: pending/rejected の遷移。ユニットで判定/ガード関数を検証できる場合は **毎PR**、画面遷移は **リリース前 or ワークフロー手動実行**。
  - **データアクセス**: DB側のRLSによる分離。**統合テストのみ**を **リリース前 or ワークフロー手動実行**（ユニットでは検証困難）。
  - **セッション管理**: 期限切れ/再ログイン誘導。ユニットでセッションヘルパーを検証できる場合は **毎PR**、実ブラウザ検証は **リリース前 or ワークフロー手動実行**。

- **実行タイミング**: [2.2 実行タイミング](#22-実行タイミングpr--リリース前) に従う。ユニットで検証可能な項目はPRで常時実行し、統合/E2Eはリリース前か ワークフロー手動実行 で実行する。

### 3.3 型安全性テスト

TypeScript と型生成の運用によって、型の破綻を早期に検知する。

- **観点**
  - **コンポーネント/ロジック型**: 型チェックと静的解析により型不整合を検知する
  - **データベース型**: 型生成の実行と差分確認により、スキーマと型定義の整合性を保つ

### 3.4 ビルドテスト

本番相当のビルドが成立することを確認する。

- **観点**
  - 本番相当のビルドが完走する
  - 依存関係のインストールが lockfile どおりに成功する

### 3.5 コード品質テスト

静的解析で品質劣化（規約違反・型エラー・デバッグ出力混入）を早期に検知する。

- **観点**
  - **Lint**: 規約違反を検知する
  - **型チェック**: 型エラーを検知する
  - **未使用コード**: ESLintのルールにより不要なimport・変数等を検知する
  - **デバッグ出力**: `console.log/info` と `debugger` の混入を検知して失敗させる

### 3.6 E2Eテスト（未実装・リリース前のみ）

実ユーザー視点の主要ジャーニーを、少数のケースで確認する（全網羅はしない）。

- **実施条件**: リリース前、または影響範囲が大きい変更（認証/認可、データ参照、主要画面の動線）
- **実施方法**: 単一ブラウザで、主要フローを1〜2本確認する（当面は手動）
- **対象フロー例**
  - ログイン → コンテンツ（資料）閲覧 → ログアウト
  - admin/maintainer による更新操作 → 一覧/詳細への反映
  - pending/rejected ユーザーが保護ページへアクセス → 適切な誘導

## 4. CI / ツール構成

### 4.1 GitHub Actions ワークフロー

GitHub Actions は CI/CD の実行基盤として利用する。詳細は各ワークフロー定義を参照する。

| Workflow | 目的 | 主な実行内容 | トリガー |
| --- | --- | --- | --- |
| Build Test ([.github/workflows/build.yml](.github/workflows/build.yml)) | 本番相当のビルド成立性を検証 | `npm ci` → `npm run build` | `push` / `pull_request`（`app/**`）、`workflow_dispatch` |
| TypeScript Type Check ([.github/workflows/typecheck.yml](.github/workflows/typecheck.yml)) | 型安全性と ESLint 違反の早期検出 | `npx tsc --noEmit` → `npm run lint` | `push` / `pull_request`（`app/**`, `*.ts(x)` 等）、`workflow_dispatch` |
| Jest Unit Tests ([.github/workflows/test.yml](.github/workflows/test.yml)) | ユニットテスト実行 | `npm test` | `push` / `pull_request`（`app/**`）、`workflow_dispatch` |
| Check console.log and debugger ([.github/workflows/check_console_log.yml](.github/workflows/check_console_log.yml)) | デバッグ用出力の混入を防止 | `find` + `grep` による検査 | `push` / `pull_request`（`app/**`）、`workflow_dispatch` |

### 4.2 導入済みツール

- **Jest**: ユニットテスト実行基盤
- **TypeScript**: 型チェック（`tsc --noEmit`）
- **ESLint**: 静的解析
- **Supabase CLI**: 型生成・スキーマ整合性確認

### 4.3 実行環境

- **Node.js 22.x**: CI 実行環境
- **Next.js**: 本番ビルド互換の検証
